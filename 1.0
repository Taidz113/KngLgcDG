--[[
    DungeonX Script - Pro VIP
    Version: Beta 0.1
    Author: HCT & Gemini
    Theme: Black & White
]]

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local VirtualUser = game:GetService("VirtualUser")

local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()

-- CẤU HÌNH BIẾN (SETTINGS)
getgenv().Config = {
    AutoRaid = false,
    SelectMode = "Easy", -- Easy, Normal, Hard
    AutoFarm = false, -- Main logic
    UseOpe = true,
    UseKioru = true,
    UseMelee = true,
    FlyHeight = 180,
    FlyRadius = 150,
    FlySpeed = 2, -- Tốc độ xoay vòng
    DodgeHealth = 80, -- % Máu để kích hoạt né
    IsDodging = false
}

-- TÌM REMOTE (Tự động tìm đường dẫn dựa trên log bạn gửi)
-- Giả sử Remote nằm trong ReplicatedStorage, tên thường là RemoteFunction hoặc tương tự
-- Bạn cần kiểm tra kỹ đường dẫn thật trong game nếu script không đánh, 
-- nhưng tôi sẽ dùng hàm chung InvokeServer cho SkillAction.
local function GetRemote()
    -- Thử tìm RemoteFunction chính. Dựa trên log là "InvokeServer", nó là RemoteFunction
    for _, v in pairs(ReplicatedStorage:GetDescendants()) do
        if v:IsA("RemoteFunction") and (v.Name == "SkillAction" or v.Name == "MainRemote") then
            return v
        end
    end
    -- Fallback nếu game để tên khác, mặc định thử tìm theo log
    return ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("SkillAction") 
end

local MainRemote = GetRemote() 
local DungeonRemote = nil -- Sẽ tìm khi chạy chức năng dungeon

-- ==========================================
-- PHẦN 1: GIAO DIỆN (UI BLACK & WHITE)
-- ==========================================

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "DungeonX_HCT"
if syn and syn.protect_gui then syn.protect_gui(ScreenGui) end
ScreenGui.Parent = game.CoreGui

local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Parent = ScreenGui
MainFrame.BackgroundColor3 = Color3.fromRGB(0, 0, 0) -- Nền Đen
MainFrame.BorderColor3 = Color3.fromRGB(255, 255, 255) -- Viền Trắng
MainFrame.BorderSizePixel = 2
MainFrame.Position = UDim2.new(0.5, -250, 0.5, -175)
MainFrame.Size = UDim2.new(0, 500, 0, 350)
MainFrame.Active = true
MainFrame.Draggable = true

local Title = Instance.new("TextLabel")
Title.Parent = MainFrame
Title.BackgroundTransparency = 1
Title.Position = UDim2.new(0, 10, 0, 5)
Title.Size = UDim2.new(1, -20, 0, 30)
Title.Font = Enum.Font.GothamBold
Title.Text = "DungeonX / made by HCT"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.TextSize = 18
Title.TextXAlignment = Enum.TextXAlignment.Left

-- INFO SECTION (BÊN TRÁI)
local InfoFrame = Instance.new("Frame")
InfoFrame.Parent = MainFrame
InfoFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
InfoFrame.BorderColor3 = Color3.fromRGB(255, 255, 255)
InfoFrame.Position = UDim2.new(0, 10, 0, 45)
InfoFrame.Size = UDim2.new(0, 140, 0, 295)

local function CreateInfoLabel(text, yPos, size)
    local lbl = Instance.new("TextLabel")
    lbl.Parent = InfoFrame
    lbl.BackgroundTransparency = 1
    lbl.Position = UDim2.new(0, 5, 0, yPos)
    lbl.Size = UDim2.new(1, -10, 0, 20)
    lbl.Font = Enum.Font.Gotham
    lbl.Text = text
    lbl.TextColor3 = Color3.fromRGB(200, 200, 200)
    lbl.TextSize = size or 12
    lbl.TextWrapped = true
    return lbl
end

CreateInfoLabel("INFO", 5, 14).Font = Enum.Font.GothamBold
CreateInfoLabel("Zalo: 0357203529", 30)
CreateInfoLabel("Feedback tại đây", 50)
CreateInfoLabel("----------------", 70)
CreateInfoLabel("Phiên bản:", 250)
CreateInfoLabel("Beta 0.1", 270).TextColor3 = Color3.fromRGB(0, 255, 0)

-- MAIN FUNCTION SECTION (BÊN PHẢI)
local FuncFrame = Instance.new("Frame")
FuncFrame.Parent = MainFrame
FuncFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
FuncFrame.BorderColor3 = Color3.fromRGB(255, 255, 255)
FuncFrame.Position = UDim2.new(0, 160, 0, 45)
FuncFrame.Size = UDim2.new(0, 330, 0, 295)

-- LOGIC UI ELEMENTS
local function CreateToggle(text, yPos, callback)
    local btn = Instance.new("TextButton")
    btn.Parent = FuncFrame
    btn.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    btn.BorderColor3 = Color3.fromRGB(255, 255, 255)
    btn.Position = UDim2.new(0, 10, 0, yPos)
    btn.Size = UDim2.new(1, -20, 0, 35)
    btn.Font = Enum.Font.GothamBold
    btn.Text = text .. " [OFF]"
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    btn.TextSize = 14

    local enabled = false
    btn.MouseButton1Click:Connect(function()
        enabled = not enabled
        if enabled then
            btn.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
            btn.TextColor3 = Color3.fromRGB(0, 0, 0)
            btn.Text = text .. " [ON]"
        else
            btn.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
            btn.TextColor3 = Color3.fromRGB(255, 255, 255)
            btn.Text = text .. " [OFF]"
        end
        callback(enabled)
    end)
    return btn
end

-- ==========================================
-- PHẦN 2: LOGIC HỆ THỐNG (SYSTEM LOGIC)
-- ==========================================

-- Hàm giả lập tham số Skill (Quan trọng để fix lỗi table 0x...)
local function GetSkillArgs(targetPos)
    -- Thường các game cần Vector3 hoặc CFrame chuột
    -- Chúng ta gửi cả 2 để chắc chắn trúng
    return {
        ["Position"] = targetPos,
        ["CFrame"] = CFrame.new(targetPos),
        ["Target"] = targetPos, -- Một số game dùng key này
        ["MouseHit"] = CFrame.new(targetPos)
    }
end

-- Hàm tìm quái (Ưu tiên Lv/HP cao nhất)
local function GetTarget()
    local mobs = workspace:GetChildren() -- Thay đổi đường dẫn nếu folder quái khác (VD: workspace.Enemies)
    local bestTarget = nil
    local maxHealth = 0

    for _, mob in pairs(mobs) do
        if mob:FindFirstChild("Humanoid") and mob:FindFirstChild("HumanoidRootPart") and mob.Humanoid.Health > 0 then
            -- Loại bỏ người chơi khỏi mục tiêu
            if not Players:GetPlayerFromCharacter(mob) then
                if mob.Humanoid.MaxHealth > maxHealth then
                    maxHealth = mob.Humanoid.MaxHealth
                    bestTarget = mob
                end
            end
        end
    end
    return bestTarget
end

-- Hàm trang bị Item (Tool)
local function EquipTool(namePartial, slotIndex)
    local Backpack = LocalPlayer.Backpack
    local Character = LocalPlayer.Character
    
    -- Nếu tool đã cầm trên tay thì thôi
    local currentTool = Character:FindFirstChildWhichIsA("Tool")
    if currentTool and string.find(string.lower(currentTool.Name), string.lower(namePartial)) then
        return currentTool
    end

    -- Tìm trong balo
    for _, tool in pairs(Backpack:GetChildren()) do
        if tool:IsA("Tool") then
             -- Logic tìm tên hoặc slot
             if string.find(string.lower(tool.Name), string.lower(namePartial)) then
                tool.Parent = Character
                return tool
             end
        end
    end
    
    -- Fallback: Nếu user không có tên item đúng, dùng Slot (Hotbar)
    -- Roblox không hỗ trợ lấy slot trực tiếp dễ dàng, nên ta dựa vào tên là chính
    -- Bạn hãy nhắc người dùng để Ope ở ô 1, Kioru ở ô 2
end

-- ==========================================
-- PHẦN 3: LOGIC AUTO FARM & SKILL
-- ==========================================

-- Biến kiểm soát Room
local LastRoomTime = 0
local RoomDuration = 25 -- Giả sử room tồn tại 25s (bạn có thể chỉnh)

local function AutoFarmLogic()
    task.spawn(function()
        while getgenv().Config.AutoFarm do
            local Target = GetTarget()
            if Target and Target:FindFirstChild("HumanoidRootPart") then
                local HRP = LocalPlayer.Character.HumanoidRootPart
                local TargetPos = Target.HumanoidRootPart.Position

                -- 1. LOGIC OPE (ROOM & FLY)
                if getgenv().Config.UseOpe then
                    -- Kiểm tra thời gian Room
                    if tick() - LastRoomTime > RoomDuration then
                        EquipTool("Ope", 1) -- Thử tìm tool tên có chữ Ope
                        task.wait(0.2)
                        -- Dùng Skill Z (Room)
                        pcall(function()
                            MainRemote:InvokeServer("SkillAction", "DF_OpOp_Z", GetSkillArgs(TargetPos))
                        end)
                        LastRoomTime = tick()
                        task.wait(0.5) -- Đợi animation
                    end
                end

                -- 2. LOGIC DI CHUYỂN (BAY VÒNG TRÒN)
                -- Bay lên 180m, Bán kính 150m
                local time = tick() * getgenv().Config.FlySpeed
                local angle = time % (math.pi * 2)
                local offsetX = math.cos(angle) * getgenv().Config.FlyRadius
                local offsetZ = math.sin(angle) * getgenv().Config.FlyRadius
                
                local newPos = TargetPos + Vector3.new(offsetX, getgenv().Config.FlyHeight, offsetZ)
                
                -- Teleport/Tween mượt mà
                local Tween = TweenService:Create(HRP, TweenInfo.new(0.1), {CFrame = CFrame.new(newPos, TargetPos)})
                Tween:Play()

                -- 3. LOGIC TẤN CÔNG (KIORU V2)
                if getgenv().Config.UseKioru then
                    EquipTool("Kioru", 2) -- Tìm tool tên Kioru
                    
                    -- Aim (Xoay nhân vật về phía quái)
                    HRP.CFrame = CFrame.new(HRP.Position, TargetPos)

                    -- Combo Logic: Z -> X -> Click spam
                    pcall(function()
                        MainRemote:InvokeServer("SkillAction", "SW_Kioru V2_Z", GetSkillArgs(TargetPos))
                    end)
                    task.wait(0.1)
                    pcall(function()
                        MainRemote:InvokeServer("SkillAction", "SW_Kioru V2_X", GetSkillArgs(TargetPos))
                    end)
                    
                    -- Spam Click (5 lần)
                    for i = 1, 5 do
                        if not getgenv().Config.AutoFarm then break end
                        pcall(function()
                            MainRemote:InvokeServer("SkillAction", "SW_Kioru V2_M1", GetSkillArgs(TargetPos))
                        end)
                        -- Giả lập click chuột ảo để chắc chắn
                        VirtualUser:ClickButton1(Vector2.new(Mouse.X, Mouse.Y))
                        task.wait(0.3) -- Delay nhỏ
                    end
                end

                -- 4. LOGIC MELEE (Nếu hết chiêu kia thì đổi qua đấm)
                if getgenv().Config.UseMelee then
                    -- Code chuyển vũ khí 3 và spam skill tương tự...
                    -- Hiện tại ưu tiên Kioru như bạn yêu cầu
                end

            else
                -- Không có quái thì nghỉ xíu đỡ lag
                task.wait(0.5)
            end
            task.wait()
        end
    end)
end

-- ==========================================
-- PHẦN 4: AUTO RAID & DODGE
-- ==========================================

-- Auto Dodge (Beta)
LocalPlayer.Character.Humanoid.HealthChanged:Connect(function(health)
    if getgenv().Config.AutoFarm and health < LocalPlayer.Character.Humanoid.MaxHealth then
        -- Phát hiện mất máu
        local damageTaken = LocalPlayer.Character.Humanoid.MaxHealth - health
        if damageTaken > 1 then
            -- Né cực nhanh
            local HRP = LocalPlayer.Character.HumanoidRootPart
            -- Dịch chuyển lùi lại 50 stud nhưng vẫn hướng về quái
            HRP.CFrame = HRP.CFrame * CFrame.new(0, 0, 50) 
        end
    end
end)

-- NÚT UI
CreateToggle("Auto Raid (Beta)", 10, function(val)
    getgenv().Config.AutoRaid = val
    if val then
        task.spawn(function()
            while getgenv().Config.AutoRaid do
                -- Logic Auto Raid: Teleport đến bục -> Chọn mode
                -- Cần tọa độ Raid (Bạn chưa cung cấp nên tôi để tạm)
                -- game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame = ...
                
                -- Fire chọn Mode
                pcall(function()
                    -- Tìm remote Dungeon (thường tên là SelectDungeon hoặc nằm trong list)
                     local args = {
                        [1] = getgenv().Config.SelectMode
                    }
                    -- Thử fire tất cả remote có khả năng
                    if MainRemote then
                        MainRemote:InvokeServer("SelectDungeon", getgenv().Config.SelectMode)
                    end
                end)
                task.wait(5)
            end
        end)
    end
end)

local ModeBtn = Instance.new("TextButton")
ModeBtn.Parent = FuncFrame
ModeBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
ModeBtn.Position = UDim2.new(0, 10, 0, 55)
ModeBtn.Size = UDim2.new(1, -20, 0, 30)
ModeBtn.Font = Enum.Font.Gotham
ModeBtn.Text = "Mode: Easy"
ModeBtn.TextColor3 = Color3.fromRGB(255, 255, 0)

ModeBtn.MouseButton1Click:Connect(function()
    if getgenv().Config.SelectMode == "Easy" then
        getgenv().Config.SelectMode = "Normal"
    elseif getgenv().Config.SelectMode == "Normal" then
        getgenv().Config.SelectMode = "Hard"
    else
        getgenv().Config.SelectMode = "Easy"
    end
    ModeBtn.Text = "Mode: " .. getgenv().Config.SelectMode
end)

CreateToggle("AUTO FARM (MAIN)", 95, function(val)
    getgenv().Config.AutoFarm = val
    if val then
        -- Thông báo nhắc nhở
        game:GetService("StarterGui"):SetCore("SendNotification", {
            Title = "DungeonX HCT";
            Text = "Hãy để Ope ở ô 1, Kioru ở ô 2!";
            Duration = 5;
        })
        AutoFarmLogic()
    end
end)

-- Nút đóng mở GUI (Right Ctrl)
game:GetService("UserInputService").InputBegan:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.RightControl then
        ScreenGui.Enabled = not ScreenGui.Enabled
    end
end)

